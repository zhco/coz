<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>在线聊天室</title>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    $(document).ready(function() {
      // 初始时隐藏聊天室内容
      $('#chat-container').hide();

      // 显示密码输入提示
      $('#enter-chat').click(function() {
        checkPassword();
      });

      // 初始加载聊天消息
      loadChat();

      // 设置自动刷新时间间隔（例如，每20秒）
      setInterval(loadChat, 20000);

      // 发送消息
      $('#send_message').click(function() {
        var username = $('#username').val();
        var message = $('#message').val();

        if (username && message) {
          $.ajax({
            url: 'send_message.php',
            method: 'POST',
            data: { username: username, message: message },
            success: function(response) {
              // 发送消息后重新加载聊天消息并清空输入框
              loadChat();
              $('#message').val('');
              scrollToBottom();
            },
            error: function(xhr, status, error) {
              console.error("AJAX error sending message: " + status + ", " + error);
            }
          });
        }
      });

      // 滚动到聊天框底部
      function scrollToBottom() {
        $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
      }

      // 加载聊天室内容
      function loadChat() {
        $.ajax({
          url: 'get_messages.php',
          method: 'GET',
          success: function(response) {
            $('#chatbox').html(response);
            scrollToBottom();
          },
          error: function(xhr, status, error) {
            console.error("AJAX error: " + status + ", " + error);
          }
        });
      }

      // 检查密码
      function checkPassword() {
        var password = prompt("请输入密码以进入聊天室：");
        if (password === "910605") {
          // 密码正确，显示聊天室内容
          $('#password-screen').hide();
          $('#chat-container').show();
          loadChat(); // 加载聊天室内容
        } else {
          alert("密码错误，请重试！");
        }
      }

      // 使用MutationObserver来监听DOM变化
      const observer = new MutationObserver(mutations => {
        if (mutations.some(mutation => mutation.type === 'childList' && mutation.target.id === 'chatbox')) {
          scrollToBottom();
        }
      });

      // 配置观察器选项
      const config = { childList: true, subtree: true };

      // 传入目标节点和观察选项
      observer.observe(document.getElementById('chatbox'), config);
    });
  </script>
</head>
<body>
  <div id="password-screen">
    <h2>请输入密码进入聊天室</h2>
    <button id="enter-chat">进入</button>
  </div>

  <div id="chat-container">
    <h1>在线聊天室</h1>

    <div id="chatbox" style="height: 300px; overflow-y: auto;"></div>

    <input type="text" id="username" placeholder="用户名">
    <input type="text" id="message" placeholder="请输入消息">
    <button id="send_message">发送</button>
  </div>
</body>
</html>